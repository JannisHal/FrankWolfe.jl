using FrankWolfe
using Test

using LinearAlgebra

const xp = [0.2221194121408555,
0.37070712502470504,
0.024120713402762894,
0.23878317833696794,
0.9774658250856014,
0.9328848703961752,
0.19666437903254597,
0.3108438697934143,
0.8611370560284857,
0.5638902027565588,
0.6717542256037482,
0.37500671876420233,
0.43229958494828336,
0.4455524748732561,
0.23223904983081323,
0.8786466197670292,
0.5909835272840192,
0.972946051414218,
0.8295833654216703,
0.12165838006949647,
0.5573162248498043,
0.7783217768142197,
0.9405585096577254,
0.4096010036741623,
0.4146694259495587,
0.12202417615334182,
0.12416203446866858,
0.3135396651797776,
0.8463925650597949,
0.5435139172669606,
0.05977604793386093,
0.9179329261313978,
0.9584333638309193,
0.288632342896219,
0.8445244137513961,
0.7174538816882624,
0.20921745715914342,
0.8558382048640315,
0.32234336062015523,
0.32349875021987073,
0.38283519134249555,
0.33281059318207173,
0.9068883983548414,
0.08810942376469555,
0.4540478820261079,
0.8286156745759701,
0.3251714302397716,
0.6926837792258961,
0.16918531873053577,
0.3045901922130101,
0.6854793931009404,
0.06651125212604247,
0.11380352462639065,
0.08508026574096728,
0.9547766463258776,
0.1861768772348652,
0.5484894320605861,
0.24822097257281062,
0.3889425215408887,
0.49747336643471984,
0.026478564673962035,
0.2754275925598161,
0.5969678463343207,
0.8896103799119639,
0.1108714508332197,
0.9283688295031338,
0.9713472351114413,
0.891466118006637,
0.96634040453533,
0.00355941854573949,
0.7867279585604435,
0.9510563391713888,
0.0692488661882199,
0.49865755273497236,
0.11863122104246815,
0.1710296777218261,
0.6363240295890795,
0.13113427653058585,
0.09117615810736701,
0.43340842523155443,
0.685958886328903,
0.12577668795016073,
0.26730497196368863,
0.9249813878356242,
0.20938064379327703,
0.84121853886278,
0.19283763945286048,
0.8795998946120226,
0.9245987481505632,
0.41859788484460025,
0.6468433655631147,
0.2614312743910776,
0.9109750609820051,
0.38773597147345606,
0.17899781432954076,
0.3444279212619652,
0.3161112859016656,
0.9212820835055795,
0.7501699548719438,
0.6951058583384379,
]

@testset "Away-Step CG" begin
    # n = Int(1e1)
    n = Int(1e2)
    k = Int(1e4)

    f(x) = norm(x - xp)^2
    function grad!(storage, x)
        @. storage = 2 * (x - xp)
    end

    lmo = FrankWolfe.KSparseLMO(40, 1.0);

    x0 = FrankWolfe.compute_extreme_point(lmo, zeros(n));

    x_true = [0.12350353234375012,
    0.27209110393778074,
    0.0,
    0.14016727141122137,
    0.8788498609126347,
    0.8342688140976653,
    0.09804849966458867,
    0.2122278803102099,
    0.762520998025756,
    0.46527428506180213,
    0.5731383110899947,
    0.2763906557223701,
    0.33368358870466414,
    0.3469364083512476,
    0.13362314742402948,
    0.7800306555091857,
    0.4923675971514438,
    0.8743300176920284,
    0.7309673791659859,
    0.023042422166982206,
    0.4587003056310128,
    0.6797057966923346,
    0.8419424363906949,
    0.3109849818277622,
    0.31605345089002196,
    0.023408194556267622,
    0.02554607691407875,
    0.2149237297980162,
    0.7477765410499011,
    0.44489802455365046,
    0.0,
    0.81931689320603,
    0.8598174461205567,
    0.19001641209638076,
    0.7459125562022206,
    0.6188379850233884,
    0.11060148689176605,
    0.7572221789338751,
    0.22372740088854115,
    0.22488275176529512,
    0.284219129785019,
    0.2341946062497304,
    0.8082723365726202,
    0.0,
    0.35543189944259673,
    0.7299997342954971,
    0.22655546979038524,
    0.5940677964268345,
    0.07056942851406295,
    0.20597429771486622,
    0.5868634666537537,
    0.0,
    0.015187583971033581,
    0.0,
    0.8561605803982841,
    0.0875609796999902,
    0.4498735111163422,
    0.14960499078176545,
    0.29032649382799874,
    0.3988574328131598,
    0.0,
    0.17681165291650178,
    0.4983518688353054,
    0.7909943905470009,
    0.012262073681243069,
    0.8297527786617029,
    0.8727311747195443,
    0.7928501110546807,
    0.8677243830367092,
    0.0,
    0.6881119396535601,
    0.8524403231973979,
    0.0,
    0.40004168464065204,
    0.020015251314782018,
    0.07241385334561916,
    0.5377080665830973,
    0.03252508127663023,
    0.0,
    0.3347924718913483,
    0.5873429099206633,
    0.027160714005546267,
    0.16868897205443156,
    0.8263653741928,
    0.11076473702137636,
    0.7426025409276225,
    0.09422166510582565,
    0.7809838615618168,
    0.8259826988451434,
    0.3199819115836107,
    0.5482273494711053,
    0.1628153336419523,
    0.8123589979051562,
    0.2891199134961275,
    0.08038176970742103,
    0.24581200848045473,
    0.21749530587279112,
    0.8226661817892726,
    0.6515540143276081,
    0.5964898185044082,
    ]

    primal_true = 0.922384560227507

    res1 = FrankWolfe.away_frank_wolfe(
        f,
        grad!,
        lmo,
        x0,
        max_iteration=k,
        line_search=FrankWolfe.Adaptive(L_est=100.0),
        print_iter=k / 10,
        epsilon=1e-5,
        memory_mode=FrankWolfe.InplaceEmphasis(),
        verbose=false,
        away_steps=true,
        trajectory=true,
    );

    @test norm(res1[1] - x_true) ≈ 0 atol = 1e-6
    @test res1[3] ≈ primal_true
    @test res1[5][end][1] == 10001

    x_true2 = [0.12350346826111819, 0.27209115354085583, 0.0, 0.1401672165783425, 0.8788497845237702, 0.8342689070265038, 0.09804841028601013, 0.21222793788196193, 0.7625210131524373, 0.46527419884630455, 0.5731382901817016, 0.27639074427254623, 0.3336836783225307, 0.34693652182385676, 0.13362316183594047, 0.7800306215740735, 0.49236764904598396, 0.8743300679886655, 0.7309673400497406, 0.023042434980542426, 0.45870031546200296, 0.6797058057964238, 0.8419424098030718, 0.3109850630047317, 0.31605353396234637, 0.023408228192705705, 0.025546098345887232, 0.21492377188173545, 0.7477766142653641, 0.4448979372720943, 0.0, 0.8193169753501994, 0.8598173425697071, 0.19001641878519657, 0.7459084649020062, 0.6188379043558516, 0.11060153976336483, 0.7572221991293518, 0.22372736457784417, 0.22488276151389325, 0.28421922450509274, 0.2341946080349395, 0.808272433882626, 0.0, 0.35543191874137287, 0.7299996714631453, 0.2265554045774107, 0.5940678243625631, 0.0705694581290414, 0.20597420220727036, 0.5868633398667711, 0.0, 0.015187630847602825, 0.0, 0.8561606808515242, 0.08756094538307344, 0.44987350216302363, 0.14960499772633432, 0.2903265410641928, 0.3988575159976324, 0.0, 0.17681164403739616, 0.49835185473295357, 0.790994329462199, 0.012262223600346837, 0.8297528149474559, 0.8727313229368197, 0.7928501089417059, 0.8677244191268072, 0.0, 0.6881120075346467, 0.8524403847063922, 0.0, 0.40004163554541944, 0.02001530609204436, 0.07241980742681073, 0.5377080471162249, 0.03251840326551829, 0.0, 0.334792444147503, 0.5873430101651245, 0.02716074963868712, 0.1686890887336313, 0.826365368373332, 0.11076469826936665, 0.7426025481906916, 0.09422175156982579, 0.7809839494286392, 0.8259827916133841, 0.3199819914750823, 0.548227347137636, 0.16281541712400893, 0.8123590237819581, 0.2891200165946391, 0.0803818686759143, 0.24581196394013258, 0.21749538680767178, 0.8226661232482805, 0.6515570053089824, 0.5964898973924625]

    primal_true2 = 0.9223845603744971

    res2 = FrankWolfe.away_frank_wolfe(
        f,
        grad!,
        lmo,
        x0,
        max_iteration=k,
        line_search=FrankWolfe.Adaptive(L_est=100.0,eta=0.95),
        print_iter=k / 10,
        epsilon=1e-5,
        momentum=0.9,
        memory_mode=FrankWolfe.OutplaceEmphasis(),
        verbose=false,
        away_steps=true,
        trajectory=true,
    );

    @test norm(res2[1] - x_true2) ≈ 0 atol = 1e-6
    @test res2[3] ≈ primal_true2 atol = 1e-6
    @test res2[5][end][1] == 10001

    x_true3 = [0.123503648010696,
    0.27209132868269253,
    0.0,
    0.1401673578082355,
    0.8788499045661641,
    0.8342688327607217,
    0.09804865267892361,
    0.21222804926410116,
    0.7625210288858183,
    0.46527434163160225,
    0.5731381787974821,
    0.2763908798625783,
    0.33368368772499973,
    0.34693665031072063,
    0.13362319335773626,
    0.7800306380618464,
    0.4923675311064333,
    0.8743300737545172,
    0.7309673194607754,
    0.023042672684197345,
    0.4587002690752793,
    0.6797058684814916,
    0.8419424558428197,
    0.3109850233383267,
    0.31605344527383716,
    0.023408319578836143,
    0.025546163443015076,
    0.2149237314065279,
    0.7477766732024713,
    0.4448980099368732,
    0.0,
    0.8193169829395471,
    0.8598174301438344,
    0.19001639748514842,
    0.7459085367228351,
    0.6188380320619716,
    0.11060163804982405,
    0.7572222600914901,
    0.2237274316318281,
    0.2248828445459852,
    0.2842192517167429,
    0.23419474810174257,
    0.808272416301767,
    0.0,
    0.35543188946776344,
    0.7299997310836455,
    0.2265556194399505,
    0.5940678474826039,
    0.07056950321937226,
    0.20597430162125394,
    0.5868633246957035,
    0.0,
    0.015188328943153624,
    0.0,
    0.8561607082073089,
    0.0875610697880454,
    0.44987341226930977,
    0.14960517391100472,
    0.29032661665313764,
    0.398857455889624,
    0.0,
    0.17681166416078406,
    0.4983544700315096,
    0.7909944919665395,
    0.012255539150923889,
    0.8297528892463846,
    0.8727308579448899,
    0.7928501862357707,
    0.8677244664800808,
    0.0,
    0.688112038824875,
    0.8524403483351229,
    0.0,
    0.40004170070740974,
    0.02001534907570548,
    0.07241376932485448,
    0.5377080828934543,
    0.03252600570691558,
    0.0,
    0.33479341367760684,
    0.5873430400735536,
    0.027161264849729787,
    0.16868901501081549,
    0.8263652674355791,
    0.11076468237709632,
    0.742602533649629,
    0.09422175717936218,
    0.7809834162540356,
    0.8259828272360981,
    0.31998190254651193,
    0.548227455013202,
    0.16281535996521704,
    0.8123589805166965,
    0.28912007729644223,
    0.08038264504794501,
    0.24581205372255102,
    0.2174954546483296,
    0.822666030859034,
    0.651554295678767,
    0.5964897854222598]

    primal_true3 = 0.9223845601906837

    res3 = FrankWolfe.blended_conditional_gradient(
               f,
               grad!,
               lmo,
               x0,
               max_iteration=k,
               line_search=FrankWolfe.Adaptive(L_est=100.0),
               print_iter=k / 10,
               epsilon=1e-5,
               memory_mode=FrankWolfe.InplaceEmphasis(),
               verbose=false,
               away_steps=true,
               trajectory=true,
           )

    @test norm(res3[1] - x_true3) ≈ 0 atol = 2e-6
    @test res3[3] ≈ primal_true3
    @test res3[5][end][1] == 283

    x_true4 = [0.123503648010696,
    0.27209132868269253,
    0.0,
    0.1401673578082355,
    0.8788499045661641,
    0.8342688327607217,
    0.09804865267892361,
    0.21222804926410116,
    0.7625210288858183,
    0.46527434163160225,
    0.5731381787974821,
    0.2763908798625783,
    0.33368368772499973,
    0.34693665031072063,
    0.13362319335773626,
    0.7800306380618464,
    0.4923675311064333,
    0.8743300737545172,
    0.7309673194607754,
    0.023042672684197345,
    0.4587002690752793,
    0.6797058684814916,
    0.8419424558428197,
    0.3109850233383267,
    0.31605344527383716,
    0.023408319578836143,
    0.025546163443015076,
    0.2149237314065279,
    0.7477766732024713,
    0.4448980099368732,
    0.0,
    0.8193169829395471,
    0.8598174301438344,
    0.19001639748514842,
    0.7459085367228351,
    0.6188380320619716,
    0.11060163804982405,
    0.7572222600914901,
    0.2237274316318281,
    0.2248828445459852,
    0.2842192517167429,
    0.23419474810174257,
    0.808272416301767,
    0.0,
    0.35543188946776344,
    0.7299997310836455,
    0.2265556194399505,
    0.5940678474826039,
    0.07056950321937226,
    0.20597430162125394,
    0.5868633246957035,
    0.0,
    0.015188328943153624,
    0.0,
    0.8561607082073089,
    0.0875610697880454,
    0.44987341226930977,
    0.14960517391100472,
    0.29032661665313764,
    0.398857455889624,
    0.0,
    0.17681166416078406,
    0.4983544700315096,
    0.7909944919665395,
    0.012255539150923889,
    0.8297528892463846,
    0.8727308579448899,
    0.7928501862357707,
    0.8677244664800808,
    0.0,
    0.688112038824875,
    0.8524403483351229,
    0.0,
    0.40004170070740974,
    0.02001534907570548,
    0.07241376932485448,
    0.5377080828934543,
    0.03252600570691558,
    0.0,
    0.33479341367760684,
    0.5873430400735536,
    0.027161264849729787,
    0.16868901501081549,
    0.8263652674355791,
    0.11076468237709632,
    0.742602533649629,
    0.09422175717936218,
    0.7809834162540356,
    0.8259828272360981,
    0.31998190254651193,
    0.548227455013202,
    0.16281535996521704,
    0.8123589805166965,
    0.28912007729644223,
    0.08038264504794501,
    0.24581205372255102,
    0.2174954546483296,
    0.822666030859034,
    0.651554295678767,
    0.5964897854222598]

    primal_true4 = 0.9223845601906837

    res4 = FrankWolfe.blended_conditional_gradient(
               f,
               grad!,
               lmo,
               x0,
               max_iteration=k,
               line_search=FrankWolfe.Adaptive(L_est=100.0),
               print_iter=k / 10,
               epsilon=1e-5,
               momentum=0.9,
               memory_mode=FrankWolfe.OutplaceEmphasis(),
               verbose=false,
               away_steps=true,
               trajectory=true,
           )

    @test norm(res4[1] - x_true4) ≈ 0 atol = 2e-6
    @test res4[3] ≈ primal_true4
    @test res4[5][end][1] == 283

end
